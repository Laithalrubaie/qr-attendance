<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Attendance Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        body { overscroll-behavior: none; }
        .scanner-border { 
            box-shadow: inset 0 0 0 4px rgba(34, 197, 94, 0.5);
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: inset 0 0 0 4px rgba(34, 197, 94, 0.5); }
            50% { box-shadow: inset 0 0 0 4px rgba(34, 197, 94, 0.9); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    
    <div class="bg-indigo-600 text-white p-4 shadow-lg sticky top-0 z-10">
        <div class="flex items-center justify-center max-w-md mx-auto">
            <div class="flex items-center gap-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                </svg>
                <h1 class="text-xl font-bold">Event Scanner</h1>
            </div>
        </div>
    </div>

    <div class="max-w-md mx-auto p-4 space-y-4 pb-20">
        
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="relative aspect-video bg-black">
                <video id="video" autoplay playsinline muted class="w-full h-full object-cover"></video>
                <canvas id="canvas" class="hidden"></canvas>
                <div id="scannerOverlay" class="hidden absolute inset-0 scanner-border pointer-events-none"></div>
                <div id="cameraPlaceholder" class="absolute inset-0 flex items-center justify-center text-white">
                    <div class="text-center">
                        <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                        </svg>
                        <p>Camera Paused</p>
                    </div>
                </div>
            </div>

            <div class="p-4 bg-gray-50 flex gap-2">
                <button id="toggleCamera" onclick="toggleCamera()" 
                    class="flex-1 py-3 rounded-lg font-semibold transition flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white shadow-md">
                    <span id="cameraButtonText">Start Camera</span>
                </button>
                
                <button onclick="switchCamera()" id="switchBtn" disabled
                    class="px-4 py-3 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white rounded-lg transition shadow-md">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </button>
            </div>
            
            <div id="scanNextContainer" class="hidden p-4 bg-green-50 border-t-2 border-green-500">
                <button onclick="enableNextScan()" 
                    class="w-full py-4 rounded-lg font-bold text-lg transition flex items-center justify-center gap-3 bg-green-500 hover:bg-green-600 text-white shadow-lg animate-pulse">
                    <span>âœ… Scan Next Person</span>
                </button>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-3 flex items-center gap-2">
            <div id="statusDot" class="w-3 h-3 rounded-full bg-gray-300"></div>
            <span id="statusText" class="text-sm font-medium text-gray-700">System Ready</span>
        </div>

        <div class="bg-white rounded-2xl shadow-xl flex flex-col overflow-hidden" style="height: 350px;">
            <div class="p-4 border-b border-gray-200 bg-gray-50">
                <h2 class="font-semibold text-gray-700">Recent Scans</h2>
            </div>
            
            <div id="logsContainer" class="flex-1 overflow-y-auto p-4 space-y-2">
                <p class="text-gray-400 text-center py-8 text-sm">Waiting for scans...</p>
            </div>
        </div>
    </div>
<script>
        // --- CONFIGURATION ---
        const CONFIG = {
            apiUrl: 'https://qr-attendance-pink.vercel.app/api' 
        };

        // --- STATE ---
        let cameraActive = false;
        let facingMode = 'environment';
        let stream = null;
        let scanInterval = null;
        let scannedCodes = new Set();
        let scanningEnabled = true;

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // --- LOGGING ---
        function addLog(message, type = 'info') {
            const container = document.getElementById('logsContainer');
            const time = new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'});
            
            const colors = {
                success: 'bg-green-50 border-green-200 text-green-800',
                error: 'bg-red-50 border-red-200 text-red-800',
                info: 'bg-blue-50 border-blue-200 text-blue-800'
            };

            if (container.querySelector('.text-gray-400')) container.innerHTML = '';

            const logEntry = document.createElement('div');
            logEntry.className = `p-3 rounded-lg text-sm border ${colors[type] || colors.info} animate-fade-in-down`;
            logEntry.innerHTML = `
                <div class="flex justify-between">
                    <span class="font-medium">${message}</span>
                    <span class="text-xs opacity-70">${time}</span>
                </div>`;
            
            container.insertBefore(logEntry, container.firstChild);
        }

        // --- CAMERA LOGIC ---
        async function startCamera() {
            try {
                const constraints = { video: { facingMode: facingMode, width: { ideal: 1280 }, height: { ideal: 720 } } };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    cameraActive = true;
                    updateUI(true);
                    startScanning();
                };
            } catch (error) {
                addLog(`Camera Error: ${error.message}`, 'error');
                cameraActive = false;
                updateUI(false);
            }
        }

        function stopCamera() {
            if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; }
            video.srcObject = null;
            cameraActive = false;
            stopScanning();
            updateUI(false);
        }

        function toggleCamera() { cameraActive ? stopCamera() : startCamera(); }
        function switchCamera() {
            stopCamera();
            facingMode = facingMode === 'environment' ? 'user' : 'environment';
            setTimeout(startCamera, 300);
        }

        function updateUI(isActive) {
            const overlay = document.getElementById('scannerOverlay');
            const placeholder = document.getElementById('cameraPlaceholder');
            const btnText = document.getElementById('cameraButtonText');
            const btnToggle = document.getElementById('toggleCamera');
            const btnSwitch = document.getElementById('switchBtn');
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');

            if (isActive) {
                overlay.classList.remove('hidden');
                placeholder.classList.add('hidden');
                btnText.textContent = 'Stop Camera';
                btnToggle.classList.replace('bg-green-500', 'bg-red-500');
                btnToggle.classList.replace('hover:bg-green-600', 'hover:bg-red-600');
                btnSwitch.disabled = false;
                statusDot.className = 'w-3 h-3 rounded-full bg-green-500 animate-pulse';
                statusText.textContent = 'Scanning Active';
            } else {
                overlay.classList.add('hidden');
                placeholder.classList.remove('hidden');
                btnText.textContent = 'Start Camera';
                btnToggle.classList.replace('bg-red-500', 'bg-green-500');
                btnToggle.classList.replace('hover:bg-red-600', 'hover:bg-green-600');
                btnSwitch.disabled = true;
                statusDot.className = 'w-3 h-3 rounded-full bg-gray-300';
                statusText.textContent = 'System Ready';
            }
        }

        // --- SCANNING LOGIC ---
        function startScanning() { scanInterval = setInterval(scanFrame, 200); }
        function stopScanning() { if (scanInterval) clearInterval(scanInterval); }

        function scanFrame() {
            if (!cameraActive || video.readyState !== video.HAVE_ENOUGH_DATA || !scanningEnabled) return;
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            if (window.jsQR) {
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                if (code && code.data) handleScanSuccess(code.data);
            }
        }

        // --- DATA PROCESSING (UPDATED) ---
        function handleScanSuccess(data) {
            if (scannedCodes.has(data)) return; 

            let payload = {}; // Logic determines what we send

            // CASE 1: TELEGRAM (@username)
            if (data.startsWith('@')) {
                addLog(`ðŸ”¹ Telegram detected: ${data}`, 'info');
                payload = { telegram: data };
            } 
            // CASE 2: PHONE NUMBER (077..., 77..., +964...)
            else {
                // Keep only numbers
                let digits = data.replace(/\D/g, '');
                if (digits.length < 6) return; // Too short to be a phone
                
                // We send the raw digits. The backend will handle the "Contains" logic.
                payload = { phone: digits };
            }

            scanningEnabled = false;
            document.getElementById('statusDot').className = 'w-3 h-3 rounded-full bg-yellow-500';
            document.getElementById('statusText').textContent = 'Processing...';

            scannedCodes.add(data);
            sendToBackend(payload);
        }

        // --- API COMMUNICATION ---
        async function sendToBackend(payload) {
            try {
                const response = await fetch(`${CONFIG.apiUrl}/record`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload) // Sends either {phone: "..."} or {telegram: "..."}
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.details || result.error || 'Unknown Server Error');
                }

                // Success Message
                let msg = "";
                if (result.type === 'UPDATE') {
                    msg = `âœ… Found & Checked: ${result.matchedValue}`;
                } else {
                    msg = `ðŸ†• New Entry: ${result.matchedValue}`;
                }
                addLog(msg, 'success');
                
                document.getElementById('scanNextContainer').classList.remove('hidden');
                document.getElementById('statusDot').className = 'w-3 h-3 rounded-full bg-green-500';
                document.getElementById('statusText').textContent = 'Saved!';

            } catch (error) {
                addLog(`âŒ Error: ${error.message}`, 'error');
                scanningEnabled = true; 
                scannedCodes.clear();
            }
        }

        function enableNextScan() {
            scanningEnabled = true;
            scannedCodes.clear();
            document.getElementById('scanNextContainer').classList.add('hidden');
            document.getElementById('statusText').textContent = 'Scanning Active';
            document.getElementById('statusDot').className = 'w-3 h-3 rounded-full bg-green-500 animate-pulse';
            addLog('waiting for next...', 'info');
        }
    </script>
</body>
</html>
