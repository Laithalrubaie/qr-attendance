<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Attendance Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        body { overscroll-behavior: none; }
        
        /* THE RED LASER LINE ANIMATION */
        .scanner-laser {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(to right, transparent, #ef4444, transparent);
            box-shadow: 0 0 10px #ef4444;
            animation: scan-line 2s linear infinite;
            z-index: 10;
        }

        @keyframes scan-line {
            0% { top: 0%; opacity: 0; }
            5% { opacity: 1; }
            95% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        /* Green Border Pulse */
        .scanner-border { 
            box-shadow: inset 0 0 0 4px rgba(34, 197, 94, 0.5);
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen">
    
    <div class="bg-gray-800 text-white p-4 shadow-lg sticky top-0 z-10 border-b border-gray-700">
        <div class="flex items-center justify-center max-w-md mx-auto">
            <h1 class="text-xl font-bold tracking-wider flex items-center gap-2">
                üì∑ EVENT SCANNER
            </h1>
        </div>
    </div>

    <div class="max-w-md mx-auto p-4 space-y-4 pb-20">
        
        <div class="bg-black rounded-xl shadow-2xl overflow-hidden border border-gray-700 relative">
            <div class="relative aspect-video bg-black">
                <video id="video" autoplay playsinline muted class="w-full h-full object-cover opacity-90"></video>
                <canvas id="canvas" class="hidden"></canvas>
                
                <div id="scannerOverlay" class="hidden absolute inset-0 scanner-border pointer-events-none">
                    <div class="scanner-laser"></div>
                </div>

                <div id="cameraPlaceholder" class="absolute inset-0 flex items-center justify-center text-gray-500">
                    <p>Camera Off</p>
                </div>
            </div>

            <div class="p-4 bg-gray-800 flex gap-2">
                <button id="toggleCamera" onclick="toggleCamera()" 
                    class="flex-1 py-4 rounded-lg font-bold transition flex items-center justify-center gap-2 bg-green-600 hover:bg-green-500 text-white shadow-lg uppercase tracking-wide">
                    <span id="cameraButtonText">Start Scanner</span>
                </button>
                
                <button onclick="switchCamera()" id="switchBtn" disabled
                    class="px-5 bg-gray-700 hover:bg-gray-600 disabled:opacity-50 text-white rounded-lg transition">
                    üîÑ
                </button>
            </div>
        </div>

        <div id="scanNextContainer" class="hidden transform transition-all duration-300">
            <button onclick="enableNextScan()" 
                class="w-full py-4 rounded-xl font-bold text-lg bg-green-500 hover:bg-green-400 text-white shadow-lg animate-bounce flex items-center justify-center gap-2">
                ‚ú® SCAN NEXT PERSON
            </button>
        </div>

        <div class="flex items-center justify-between px-2">
            <div class="flex items-center gap-2">
                <div id="statusDot" class="w-3 h-3 rounded-full bg-red-500"></div>
                <span id="statusText" class="text-gray-300 text-sm font-mono">SYSTEM READY</span>
            </div>
        </div>

        <div class="bg-gray-800 rounded-xl shadow-inner border border-gray-700 flex flex-col h-64">
            <div class="p-3 border-b border-gray-700 bg-gray-900/50">
                <h2 class="text-gray-400 text-xs font-mono uppercase tracking-widest">Scan Log</h2>
            </div>
            <div id="logsContainer" class="flex-1 overflow-y-auto p-3 space-y-2 font-mono text-sm">
                <p class="text-gray-600 text-center py-4 text-xs">Waiting for data...</p>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CONFIG = {
            apiUrl: 'https://qr-attendance-pink.vercel.app/api' 
        };

        // --- STATE ---
        let cameraActive = false;
        let facingMode = 'environment';
        let stream = null;
        let scanInterval = null;
        let scannedCodes = new Set();
        let scanningEnabled = true;

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // --- üîä SOUND ENGINE (The "Peep") ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playBeep() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(1200, audioCtx.currentTime); 
            oscillator.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.1); 
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.15);
        }

        // --- LOGGING UI ---
        function addLog(message, type = 'info') {
            const container = document.getElementById('logsContainer');
            const time = new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'});
            if (container.querySelector('.text-gray-600')) container.innerHTML = '';

            const colors = {
                success: 'text-green-400 border-green-900/30 bg-green-900/10',
                error: 'text-red-400 border-red-900/30 bg-red-900/10',
                info: 'text-blue-400 border-blue-900/30 bg-blue-900/10'
            };

            const logEntry = document.createElement('div');
            logEntry.className = `p-2 rounded border-l-2 ${colors[type] || colors.info} mb-1 animate-fade-in`;
            logEntry.innerHTML = `
                <div class="flex justify-between items-center">
                    <span>${message}</span>
                    <span class="text-xs opacity-50">${time}</span>
                </div>`;
            container.insertBefore(logEntry, container.firstChild);
        }

        // --- CAMERA ---
        async function startCamera() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            try {
                const constraints = { video: { facingMode: facingMode, width: { ideal: 1280 }, height: { ideal: 720 } } };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    cameraActive = true;
                    updateUI(true);
                    startScanning();
                };
            } catch (error) {
                addLog(`Camera Error: ${error.message}`, 'error');
                cameraActive = false;
                updateUI(false);
            }
        }

        function stopCamera() {
            if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; }
            video.srcObject = null;
            cameraActive = false;
            stopScanning();
            updateUI(false);
        }

        function toggleCamera() { cameraActive ? stopCamera() : startCamera(); }
        function switchCamera() {
            stopCamera();
            facingMode = facingMode === 'environment' ? 'user' : 'environment';
            setTimeout(startCamera, 300);
        }

        function updateUI(isActive) {
            const overlay = document.getElementById('scannerOverlay');
            const placeholder = document.getElementById('cameraPlaceholder');
            const btnText = document.getElementById('cameraButtonText');
            const btnToggle = document.getElementById('toggleCamera');
            const btnSwitch = document.getElementById('switchBtn');
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');

            if (isActive) {
                overlay.classList.remove('hidden');
                placeholder.classList.add('hidden');
                btnText.textContent = 'STOP SCANNER';
                btnToggle.classList.replace('bg-green-600', 'bg-red-600');
                btnToggle.classList.replace('hover:bg-green-500', 'hover:bg-red-500');
                btnSwitch.disabled = false;
                statusDot.className = 'w-3 h-3 rounded-full bg-green-500 animate-pulse';
                statusText.textContent = 'SCANNING...';
            } else {
                overlay.classList.add('hidden');
                placeholder.classList.remove('hidden');
                btnText.textContent = 'START SCANNER';
                btnToggle.classList.replace('bg-red-600', 'bg-green-600');
                btnToggle.classList.replace('hover:bg-red-500', 'hover:bg-green-500');
                btnSwitch.disabled = true;
                statusDot.className = 'w-3 h-3 rounded-full bg-red-500';
                statusText.textContent = 'SYSTEM READY';
            }
        }

        // --- SCANNING ---
        function startScanning() { scanInterval = setInterval(scanFrame, 200); }
        function stopScanning() { if (scanInterval) clearInterval(scanInterval); }

        function scanFrame() {
            if (!cameraActive || video.readyState !== video.HAVE_ENOUGH_DATA || !scanningEnabled) return;
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            if (window.jsQR) {
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                if (code && code.data) handleScanSuccess(code.data);
            }
        }

        // --- SMART DATA PARSING (The Fix) ---
        function parseQRData(text) {
            // Split by pipe (|), tab, or multiple spaces
            let parts = text.split(/[\|\t]+| {2,}/).map(item => item.trim());
            let phone = "";
            let telegram = "";
            
            parts.forEach(part => {
                // Check if part is a Phone Number
                if (part.match(/^(\+?964|07|00964|\d{10,})/)) {
                    phone = part.replace(/\D/g, ''); 
                } 
                // Check if Telegram
                else if (part.startsWith('@')) {
                    telegram = part;
                }
            });

            return { phone, telegram };
        }

        function handleScanSuccess(data) {
            if (scannedCodes.has(data)) return; 
            playBeep();

            // Use the Smart Parser
            const parsed = parseQRData(data);
            let payload = {};

            if (parsed.telegram) {
                addLog(`üîπ Telegram: ${parsed.telegram}`, 'info');
                payload = { telegram: parsed.telegram };
            } 
            else if (parsed.phone && parsed.phone.length > 5) {
                payload = { phone: parsed.phone };
            } 
            else {
                // Fallback: If no pipe structure, try simple extraction
                let digits = data.replace(/\D/g, '');
                if (digits.length > 5) {
                    payload = { phone: digits };
                } else {
                    return; // Invalid scan
                }
            }

            scanningEnabled = false;
            document.getElementById('statusDot').className = 'w-3 h-3 rounded-full bg-yellow-500';
            document.getElementById('statusText').textContent = 'PROCESSING...';
            scannedCodes.add(data);
            sendToBackend(payload);
        }

        // --- API ---
        async function sendToBackend(payload) {
            try {
                const response = await fetch(`${CONFIG.apiUrl}/record`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.details || result.error || 'Server Error');

                // FIX: Use matchedValue OR fall back to record.Name
                const displayName = result.matchedValue || (result.record ? result.record.Name : "Unknown");
                
                let msg = result.type === 'UPDATE' ? `‚úÖ Checked: ${displayName}` : `üÜï Added: ${displayName}`;
                addLog(msg, 'success');
                
                document.getElementById('scanNextContainer').classList.remove('hidden');
                document.getElementById('statusDot').className = 'w-3 h-3 rounded-full bg-green-500';
                document.getElementById('statusText').textContent = 'COMPLETED';

            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`, 'error');
                scanningEnabled = true; 
                scannedCodes.clear();
            }
        }

        function enableNextScan() {
            scanningEnabled = true;
            scannedCodes.clear();
            document.getElementById('scanNextContainer').classList.add('hidden');
            document.getElementById('statusText').textContent = 'SCANNING...';
            document.getElementById('statusDot').className = 'w-3 h-3 rounded-full bg-green-500 animate-pulse';
            addLog('Ready for next...', 'info');
        }
    </script>
</body>
</html>
