<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Attendance Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        body { overscroll-behavior: none; }
        .scanner-border { 
            box-shadow: inset 0 0 0 4px rgba(34, 197, 94, 0.5);
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: inset 0 0 0 4px rgba(34, 197, 94, 0.5); }
            50% { box-shadow: inset 0 0 0 4px rgba(34, 197, 94, 0.9); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    
    <!-- Header -->
    <div class="bg-indigo-600 text-white p-4 shadow-lg sticky top-0 z-10">
        <div class="flex items-center justify-center max-w-md mx-auto">
            <div class="flex items-center gap-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
                <h1 class="text-xl font-bold">QR Attendance Scanner</h1>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-md mx-auto p-4 space-y-4 pb-20">
        
        <!-- Video Area -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="relative aspect-video bg-black">
                <video id="video" autoplay playsinline muted class="w-full h-full object-cover"></video>
                <canvas id="canvas" class="hidden"></canvas>
                <div id="scannerOverlay" class="hidden absolute inset-0 scanner-border pointer-events-none"></div>
                <div id="cameraPlaceholder" class="absolute inset-0 flex items-center justify-center text-white">
                    <div class="text-center">
                        <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <p>Camera Inactive</p>
                        <p class="text-sm mt-2 opacity-75">Click "Start Camera" below</p>
                    </div>
                </div>
            </div>

            <!-- Camera Controls -->
            <div class="p-4 bg-gray-50 flex gap-2">
                <button id="toggleCamera" onclick="toggleCamera()" 
                    class="flex-1 py-3 rounded-lg font-semibold transition flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                    </svg>
                    <span id="cameraButtonText">Start Camera</span>
                </button>
                
                <button onclick="switchCamera()" id="switchBtn" disabled
                    class="px-4 py-3 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white rounded-lg transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Scan Next Button (Shows after successful scan) -->
            <div id="scanNextContainer" class="hidden p-4 bg-green-50 border-t-2 border-green-500">
                <button onclick="enableNextScan()" 
                    class="w-full py-4 rounded-lg font-bold text-lg transition flex items-center justify-center gap-3 bg-green-500 hover:bg-green-600 text-white shadow-lg animate-pulse">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                    </svg>
                    <span>‚úÖ Scan Next Teacher</span>
                </button>
                <p class="text-center text-sm text-gray-600 mt-2">Ready for the next person!</p>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="bg-white rounded-lg shadow p-3 flex items-center gap-2">
            <div id="statusDot" class="w-3 h-3 rounded-full bg-gray-300"></div>
            <span id="statusText" class="text-sm font-medium text-gray-700">System Ready</span>
        </div>

        <!-- Logs Area -->
        <div class="bg-white rounded-2xl shadow-xl flex flex-col overflow-hidden" style="height: 400px;">
            <div class="p-4 border-b border-gray-200 bg-gray-50">
                <h2 class="font-semibold text-gray-700">Activity Log</h2>
            </div>
            
            <div id="logsContainer" class="flex-1 overflow-y-auto p-4 space-y-2">
                <p class="text-gray-400 text-center py-8">No activity yet...</p>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        let CONFIG = {
            apiUrl: localStorage.getItem('apiUrl') || 'https://qr-attendance-pink.vercel.app/api'
        };

        // State
        let cameraActive = false;
        let facingMode = 'environment';
        let stream = null;
        let scanInterval = null;
        let scannedCodes = new Set();
        let lastScanTime = 0;
        let scanningEnabled = true; // New: Controls whether we can scan

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // Logging
        function addLog(message, type = 'info') {
            const container = document.getElementById('logsContainer');
            const time = new Date().toLocaleTimeString();
            
            const colors = {
                success: 'bg-green-50 border-green-200',
                error: 'bg-red-50 border-red-200',
                warning: 'bg-yellow-50 border-yellow-200',
                info: 'bg-gray-50 border-gray-200'
            };

            const icons = {
                success: '<svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
                error: '<svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
                warning: '<svg class="w-4 h-4 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>',
                info: ''
            };

            if (container.querySelector('.text-gray-400')) {
                container.innerHTML = '';
            }

            const logEntry = document.createElement('div');
            logEntry.className = `p-3 rounded-lg text-sm border ${colors[type]}`;
            logEntry.innerHTML = `
                <div class="flex items-start gap-2">
                    ${icons[type]}
                    <div class="flex-1">
                        <span class="text-gray-500 text-xs">[${time}]</span>
                        <p class="text-gray-700 mt-1">${message}</p>
                    </div>
                </div>
            `;
            
            container.insertBefore(logEntry, container.firstChild);
            console.log(`[${time}] ${message}`);
        }

        // Camera Functions
        async function startCamera() {
            try {
                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                cameraActive = true;
                
                document.getElementById('cameraPlaceholder').classList.add('hidden');
                document.getElementById('scannerOverlay').classList.remove('hidden');
                document.getElementById('toggleCamera').className = 'flex-1 py-3 rounded-lg font-semibold transition flex items-center justify-center gap-2 bg-red-500 hover:bg-red-600 text-white';
                document.getElementById('cameraButtonText').textContent = 'Stop Camera';
                document.getElementById('switchBtn').disabled = false;
                document.getElementById('statusDot').className = 'w-3 h-3 rounded-full bg-green-500 animate-pulse';
                document.getElementById('statusText').textContent = 'Scanning Active';

                startScanning();
                addLog('üì∏ Camera started successfully', 'success');
            } catch (error) {
                addLog(`‚ùå Camera error: ${error.message}`, 'error');
                cameraActive = false;
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            video.srcObject = null;
            cameraActive = false;
            stopScanning();
            
            document.getElementById('cameraPlaceholder').classList.remove('hidden');
            document.getElementById('scannerOverlay').classList.add('hidden');
            document.getElementById('toggleCamera').className = 'flex-1 py-3 rounded-lg font-semibold transition flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white';
            document.getElementById('cameraButtonText').textContent = 'Start Camera';
            document.getElementById('switchBtn').disabled = true;
            document.getElementById('statusDot').className = 'w-3 h-3 rounded-full bg-gray-300';
            document.getElementById('statusText').textContent = 'System Ready';

            addLog('üì∑ Camera stopped', 'info');
        }

        function toggleCamera() {
            if (cameraActive) {
                stopCamera();
            } else {
                startCamera();
            }
        }

        function switchCamera() {
            stopCamera();
            facingMode = facingMode === 'environment' ? 'user' : 'environment';
            setTimeout(startCamera, 100);
        }

        // QR Scanning
        function startScanning() {
            scanInterval = setInterval(scanQRCode, 200);
        }

        function stopScanning() {
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
        }

        function scanQRCode() {
            if (!cameraActive || !video.readyState === video.HAVE_ENOUGH_DATA || !scanningEnabled) return;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            if (window.jsQR) {
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                if (code) {
                    processQRCode(code.data);
                }
            }
        }

        function processQRCode(data) {
            if (!scanningEnabled) return; // Don't process if scanning is disabled
            
            const currentTime = Date.now();
            
            // No time limit check - just check if we already scanned this exact code
            if (scannedCodes.has(data)) {
                return;
            }

            try {
                // New QR Format: "ÿßÿ≥ŸÖ ÿßŸÑÿ¨Ÿáÿ©,ÿßÿ≥ŸÖ ÿßŸÑÿßÿ≥ÿ™ÿßÿ∞,ÿßŸÑŸÖÿßÿØÿ©,ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ"
                // OR simple: "ÿßÿ≥ŸÖ ÿßŸÑÿßÿ≥ÿ™ÿßÿ∞,ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ"
                
                const parts = data.split(',').map(s => s.trim());
                
                let organization = '';
                let teacherName = '';
                let subject = '';
                let phone = '';
                
                if (parts.length === 4) {
                    // Full format: Organization, Teacher, Subject, Phone
                    organization = parts[0];
                    teacherName = parts[1];
                    subject = parts[2];
                    phone = parts[3];
                } else if (parts.length === 3) {
                    // Could be: Teacher, Subject, Phone OR Organization, Teacher, Phone
                    // We'll assume: Teacher, Subject, Phone
                    teacherName = parts[0];
                    subject = parts[1];
                    phone = parts[2];
                } else if (parts.length === 2) {
                    // Simple format: Teacher, Phone
                    teacherName = parts[0];
                    phone = parts[1];
                } else {
                    addLog('‚ö†Ô∏è Invalid QR code format', 'error');
                    return;
                }
                
                // Handle corrupted phone data
                if (phone === 'nan' || phone === '') {
                    phone = teacherName;
                    teacherName = teacherName.replace(/\d+/g, '').trim();
                    addLog(`üîß Repaired phone data`, 'warning');
                }
                
                // Validate required fields
                if (!teacherName || !phone) {
                    addLog('‚ö†Ô∏è Missing required data (Teacher name or Phone)', 'error');
                    return;
                }

                addLog(`üîé Found: ${teacherName}${subject ? ` (${subject})` : ''}`, 'info');
                
                // Disable scanning immediately
                scanningEnabled = false;
                document.getElementById('statusDot').className = 'w-3 h-3 rounded-full bg-yellow-500';
                document.getElementById('statusText').textContent = 'Processing... Please wait';
                
                recordAttendance(teacherName, phone, organization, subject);                
                scannedCodes.add(data);
                lastScanTime = currentTime;
                
            } catch (error) {
                addLog(`‚ö†Ô∏è Parse error: ${error.message}`, 'error');
            }
        }

        function enableNextScan() {
            scanningEnabled = true;
            scannedCodes.clear(); // Clear history so we can scan the same QR again
            document.getElementById('scanNextContainer').classList.add('hidden');
            document.getElementById('statusDot').className = 'w-3 h-3 rounded-full bg-green-500 animate-pulse';
            document.getElementById('statusText').textContent = 'Ready - Scan Next QR Code';
            addLog('üëâ Ready for next scan!', 'info');
        }

        // Phone Formatting
        function formatPhone(phoneRaw) {
            let phone = phoneRaw.replace(/\D/g, '');
            
            if (phone.length <= 11) {
                if (phone.startsWith('0')) {
                    phone = '+964' + phone.substring(1);
                } else {
                    phone = '+964' + phone;
                }
            } else {
                phone = '+' + phone;
            }
            
            return phone;
        }

        // Record Attendance
        async function recordAttendance(name, phoneRaw, organization, subject) {
    if (!CONFIG.apiUrl) {
        addLog('‚ö†Ô∏è Please configure API URL', 'warning');
        return;
    }

    const phone = formatPhone(phoneRaw);
    const timestamp = new Date().toISOString();

    addLog(`‚öôÔ∏è Processing: ${name}`, 'info');

    try {
        const apiEndpoint = `${CONFIG.apiUrl}/record`;
        
        const response = await fetch(apiEndpoint, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ 
                teacherName: name, // This 'name' is the variable at the top of the function
                phone: phone, 
                organization: organization, 
                subject: subject, 
                timestamp: timestamp, 
                status: 'ARRIVED' 
            })
        });

        if (response.ok) {
            const result = await response.json();
            // Use 'name' here because that is what this function calls the teacher
            addLog(`‚úÖ Recorded: ${name} at ${result.time}`, 'success');
            
            if (organization && organization !== '-') addLog(`üè¢ Org: ${organization}`, 'info');
            
            document.getElementById('scanNextContainer').classList.remove('hidden');
            document.getElementById('statusDot').className = 'w-3 h-3 rounded-full bg-green-500';
            document.getElementById('statusText').textContent = 'Success! Ready for next';
        } else {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to record');
        }
    } catch (error) {
        addLog(`‚ùå Error: ${error.message}`, 'error');
        scanningEnabled = true;
    }
}

        // Initialize
        addLog('üîÑ System initialized and ready!', 'success');
        addLog('üì° API configured for Baghdad timezone', 'info');
    </script>
</body>
</html>